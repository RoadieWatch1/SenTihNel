<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SenTihNel • Confirm</title>
    <style>
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#05070a; color:#e5e7eb; }
      .wrap { max-width:560px; margin:60px auto; padding:24px; }
      .card { border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:20px; background: rgba(255,255,255,.04); }
      h1 { font-size:18px; margin:0 0 10px; }
      p { opacity:.88; line-height:1.45; }
      .msg { margin-top:14px; font-size:13px; white-space:pre-wrap; }
      .err { color:#fb7185; }
      .ok { color:#34d399; }
      .muted { opacity:.75; font-size:12px; margin-top:10px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Finishing sign-in…</h1>
        <p>Please wait. If this takes too long, request a new email link.</p>
        <div id="msg" class="msg"></div>
        <div id="debug" class="muted"></div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

      const SUPABASE_URL = "https://yjnqyzozvrgajavndgbm.supabase.co";
      const SUPABASE_KEY = "sb_publishable_t3KmD3g6zK3c-4cyzGMrQw_carXwjUq"; // anon/publishable only
      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      const setMsg = (t, cls) => {
        const el = document.getElementById("msg");
        el.className = "msg " + (cls || "");
        el.textContent = t || "";
      };

      const setDebug = (t) => {
        document.getElementById("debug").textContent = t || "";
      };

      function safeNext(raw) {
        // Allow:
        // - /reset/ or /confirm/
        // - https://sentihnel.com/reset/ (your own domain)
        if (!raw) return "/";

        try {
          if (raw.startsWith("/")) return raw;

          const u = new URL(raw);
          if (u.origin === window.location.origin) return u.pathname + u.search + u.hash;

          return "/";
        } catch {
          return "/";
        }
      }

      (async () => {
        try {
          const url = new URL(window.location.href);
          const token_hash = url.searchParams.get("token_hash");
          const type = url.searchParams.get("type");
          const nextRaw = url.searchParams.get("next");
          const next = safeNext(nextRaw);

          setDebug(`type=${type || ""} next=${next}`);

          if (!token_hash || !type) {
            setMsg("No token hash or type found in the link.\n\nRequest a NEW email link and try again.", "err");
            return;
          }

          setMsg("Verifying link…");

          const { error } = await supabase.auth.verifyOtp({ token_hash, type });
          if (error) {
            setMsg(
              "This link is invalid or expired.\n\n" +
              (error.message || String(error)) +
              "\n\nRequest a NEW email link and try again.",
              "err"
            );
            return;
          }

          setMsg("Verified. Redirecting…", "ok");
          window.location.replace(next);
        } catch (e) {
          setMsg(e?.message || String(e), "err");
        }
      })();
    </script>
  </body>
</html>
